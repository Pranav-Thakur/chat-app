<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Login | ProChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #e8f0fe;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background: white;
            padding: 40px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            position: relative;
        }

        h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 14px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 15px;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #0056b3;
        }

        .message,
        .error {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        .message {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .alert-box {
            position: fixed;
            bottom: 30px; /* Change to top: 30px; for top position */
            left: 50%;
            transform: translateX(-50%);
            background-color: #007bff;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 16px;
            display: none;
            z-index: 10000;
        }

        #progressContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #f1f1f1;
            display: none;
            z-index: 9999;
        }

        #progressBar {
            height: 4px;
            background: #007bff;
            width: 0%;
            transition: width 0.4s ease;
        }
    </style>
    <script src="/js/auth.js" type="text/javascript"></script>
    <script src="/js/constants.js" type="text/javascript"></script>
</head>
<body>
<div id="progressContainer"><div id="progressBar"></div></div>

<div class="container">
    <h3>Login to ProChat</h3>

    <input type="text" id="phone" placeholder="ðŸ“± Enter Phone Number" />
    <button id="firstButton" onclick="sendOTP()">Send OTP</button>

    <input type="text" id="otp" placeholder="ðŸ”‘ Enter OTP" />
    <input type="hidden" id="agent" name="agent" />
    <input type="hidden" id="ip" name="ip" />
    <button id="secondButton" onclick="verifyOTP()">Verify</button>

    <div class="message" id="msg"></div>
    <div class="error" id="error"></div>
    <div id="customAlert" class="alert-box"></div>
</div>


<script>
    async function sendOTP() {
        try {
            const phone = document.getElementById("phone").value;
            if (!phone) return showError("Enter phone number");

            showProgressBar();
            let deviceId = AuthService.getDeviceId();
            const res = await AuthService.apiFetch(AuthConstants.API.LOGIN, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phoneNumber: phone, agent: getSimpleAgent() + ", " + getSimpleOS(), deviceId: deviceId})
            });

            const data = await res.json();
            if (res.ok) {
                let sessionId = data.sessionId;
                if (!sessionId) {
                    showError("please try again, faced some issue generating otp.");
                    hideProgressBar();
                    return;
                }
                AuthService.setItemWithExpiry(AuthConstants.STORAGE_KEYS.SESSION_ID, sessionId, AuthConstants.TTL.SESSION_TOKEN);

                showMessage(data.message);
                document.getElementById("phone").hidden = true;
                document.getElementById("firstButton").hidden = true;
            } else {
                showError(data.message || "Failed to send OTP");
            }
        } catch (err) {
            showError("Error: " + err.message);
        }
        hideProgressBar();
    }

    async function verifyOTP() {
        try {
            const otp = document.getElementById("otp").value;
            if (!otp) return showError("Enter OTP first");

            showProgressBar();
            let deviceId = AuthService.getItemWithExpiry(AuthConstants.STORAGE_KEYS.DEVICE_ID);
            let sessionId = AuthService.getItemWithExpiry(AuthConstants.STORAGE_KEYS.SESSION_ID);
            const res = await AuthService.apiFetch(AuthConstants.API.VERIFY, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({sessionId: sessionId, otp: otp, agent: getSimpleAgent() + ", " + getSimpleOS(), deviceId: deviceId })
            });

            const data = await res.json();
            if (res.ok) {
                showMessage(data.message);
                if (data.userId) {
                    AuthService.setItemWithExpiry(AuthConstants.STORAGE_KEYS.USER_ID, data.userId);
                    AuthService.removeItem(AuthConstants.STORAGE_KEYS.SESSION_ID);
                    await callApiCheckSessionForValidity(data.userId);
                } else {
                    console.debug("verifyOTP sessionId:", data.sessionId);
                    initiateRegister();
                }
            } else if (res.status === 401) {
                throw new Error(JSON.stringify(data));
            } else {
                showError(data.message || "OTP verification failed");
            }
        } catch (err) {
            showError("Error: " + err.message);
            AuthService.removeItem(AuthConstants.STORAGE_KEYS.SESSION_ID);
            setTimeout(() => {
                document.getElementById("phone").hidden = true;
                document.getElementById("firstButton").hidden = true;
                showError("");
                alert("try getting otp again.");
            }, 3000); // 5 seconds delay
        }
        hideProgressBar();
    }

    async function callRegister() {
        try {
            const email = document.getElementById("phone").value;
            const name = document.getElementById("otp").value;
            const about = document.getElementById("agent").value;
            let sessionId = AuthService.getItemWithExpiry(AuthConstants.STORAGE_KEYS.SESSION_ID);
            console.debug("callRegister sessionId:", sessionId);

            if (!email || !name) return showError("Enter details properly");

            showProgressBar();
            const res = await AuthService.apiFetch(AuthConstants.API.REGISTER, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({sessionId: sessionId, email: email, about: about, name: name })
            });

            const data = await res.json();
            if (res.ok) {
                showMessage("Register successful!");
                AuthService.setItemWithExpiry(AuthConstants.STORAGE_KEYS.USER_ID, data.userId);
                AuthService.setItemWithExpiry(AuthConstants.STORAGE_KEYS.CURRENT_USER_DATA, JSON.stringify(data));
                AuthService.removeItem(AuthConstants.STORAGE_KEYS.SESSION_ID);
                // âœ… Optionally redirect to your dashboard
                setTimeout(() => {
                    window.location.href = "/dashboard.html";
                }, 2000); // 2 sec delay
            } else {
                showError(data.message || "Register failed.");
            }
        } catch (err) {
            showError("Error: " + err.message);
        }
        AuthService.removeItem(AuthConstants.STORAGE_KEYS.SESSION_ID);
        showCustomAlert("Register failed, so refresh to start again.", 10000);
        hideProgressBar();
    }

    function initiateRegister() {
        try {
            document.getElementById("firstButton").hidden = true;

            const emailEle = document.getElementById("phone");
            emailEle.hidden = false;
            emailEle.value = '';
            emailEle.placeholder = 'âœ‰ï¸ Enter user email';

            const nameEle = document.getElementById("otp");
            nameEle.hidden = false;
            nameEle.value = '';
            nameEle.placeholder = 'Enter user name';

            const aboutEle = document.getElementById("agent");
            aboutEle.type = 'text';
            aboutEle.hidden = false;
            nameEle.value = '';
            aboutEle.placeholder = 'Enter user\'s about';

            document.getElementById("secondButton").innerHTML = 'Register';
            document.getElementById("secondButton").onclick = callRegister;
        } catch (err) {
            showError("Error: " + err.message);
        }
    }

    function showMessage(msg) {
        document.getElementById("msg").textContent = msg;
        document.getElementById("error").textContent = "";
    }

    function showError(msg) {
        document.getElementById("error").textContent = msg;
        document.getElementById("msg").textContent = "";
    }

    function getSimpleAgent() {
        const ua = navigator.userAgent;

        if (ua.includes("Firefox/")) return "Firefox";
        if (ua.includes("Edg/")) return "Edge";
        if (ua.includes("Chrome/") && !ua.includes("Edg/")) return "Chrome";
        if (ua.includes("Safari/") && !ua.includes("Chrome")) return "Safari";
        if (ua.includes("OPR/")) return "Opera";
        return "Unknown";
    }

    function getSimpleOS() {
        const ua = navigator.userAgent;

        if (ua.includes("Win")) return "Windows";
        if (ua.includes("Mac")) return "macOS";
        if (ua.includes("Linux")) return "Linux";
        if (ua.includes("Android")) return "Android";
        if (ua.includes("like Mac")) return "iOS";
        return "Unknown OS";
    }

    async function callApiCheckSessionForValidity(userId, redirectIfOk = true) {
        const sessionChecked = AuthService.getItemWithExpiry(AuthConstants.STORAGE_KEYS.LAST_CHECK_SESSION_API_CALL);
        if (sessionChecked) {
            // no need to call api
            console.info("check session no need to call");
            return;
        }

        const res = await AuthService.apiFetch(AuthConstants.API.CHECK_SESSION.replace("{userId}", userId));
        if (!res.ok) showError("check session failed, please refresh");
        else {
            // Token valid, redirect to chat
            const sessionCheckData = await res.json();
            AuthService.setItemWithExpiry(AuthConstants.STORAGE_KEYS.LAST_CHECK_SESSION_API_CALL, true, AuthConstants.TTL.CHECK_SESSION);
            AuthService.setItemWithExpiry(AuthConstants.STORAGE_KEYS.CURRENT_USER_DATA, JSON.stringify(sessionCheckData));

            if (redirectIfOk) {
                setTimeout(() => {
                    window.location.href = "/dashboard.html";
                }, 2000); // 2 seconds delay
            }
        }
    }

    window.alert = function(message) {
        showCustomAlert(message);
    };

    window.onload = async () => {
        showProgressBar();
        try {
            let userId = AuthService.getItemWithExpiry(AuthConstants.STORAGE_KEYS.USER_ID);
            await callApiCheckSessionForValidity(userId);
        } catch (e) {
            console.error(e);
        }
        alert("Please Login to continue");
        hideProgressBar();
    };

    function showProgressBar() {
        const bar = document.getElementById('progressBar');
        const container = document.getElementById('progressContainer');
        container.style.display = 'block';
        bar.style.width = '0%';

        // Animate progress to 90% while waiting
        setTimeout(() => { bar.style.width = '90%'; }, 100);
    }

    function hideProgressBar() {
        const bar = document.getElementById('progressBar');
        bar.style.width = '100%';
        setTimeout(() => {
            document.getElementById('progressContainer').style.display = 'none';
            bar.style.width = '0%';
        }, 400);
    }

    function showCustomAlert(message, duration = 3000) {
        const alertBox = document.getElementById('customAlert');
        alertBox.textContent = message;
        alertBox.style.display = 'block';

        setTimeout(() => {
            alertBox.style.display = 'none';
        }, duration);
    }

</script>


</body>
</html>